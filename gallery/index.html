<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive 3D Image Gallery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="data.js"></script>
    <script src="layers.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
        }
        .gallery {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        margin: 20px;
    }

    .gallery img {
        width: 200px;
        height: 267px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .gallery img:hover {
        transform: scale(1.05);
    }

    .filter-group {
        margin: 20px;
    }

    .filter-group label {
        margin-right: 10px;
    }
    .clickable{
        cursor: pointer;
        font-weight: bold;
    }
    .layer{
        max-width: 60px;
        max-height: 60px;
    }
</style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mt-4 mb-4">Interactive 3D Image Gallery</h1>
        <div class="filter-group">
            <span class="clickable" onclick="toggle('talent-filters')">&#8964; Talent:</span>
            <div id="talent-filters"></div>
            <hr>
            <span class="clickable" onclick="toggle('species-filters')">&#8964; Species:</span>
            <div id="species-filters"></div>
            <hr>
            <span class="clickable" onclick="toggle('gender-filters')">&#8964; Gender:</span>
            <div id="gender-filters"></div>
            <hr>
            <span class="clickable" onclick="toggle('layer-filters')">&#8964; Layers:</span>
            <div id="layer-filters"></div>
        </div>
        <div class="gallery" id="gallery"></div>
        <input type="button" onclick="loadMore()"  id="load_more" value="Load More" style="margin-left: 46.5%;">
    </div>
    <script>
        
        let pageSize = 100;
        let loadedCount = 0;
        let filteredData = data;
        const uniqueAttributes = (attr) => {
            return [...new Set(data.map((item) => item[attr]))];
        };

        function toggle(elm){
            let el = document.getElementById(elm);
            el.style.display = el.style.display == 'none' ? 'block' : 'none';
        }
        function loadMore(){
            pageSize += 100;
            displayGallery(filteredData);
        }

        const createFilterCheckboxes = (attribute, container) => {
            const values = uniqueAttributes(attribute);
            const filterContainer = document.getElementById(container);
            values.forEach((value) => {
                const label = document.createElement("label");
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.value = value;
                checkbox.addEventListener("change", applyFilters);
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(' '+value));
                filterContainer.appendChild(label);
            });
        };

        const createFilterCheckboxes2 = (attribute, container, type) => {
            const values = uniqueAttributes(attribute);
            const filterContainer = document.getElementById(container);
            let used = {};
            values.forEach((values) => {
                values.forEach((value)=>{
                    let layer = layers.find((val)=>val.layerNum==value);
                    let layerName = layer.traitValue != '' ? layer.traitValue : layer.tagText;
                    let layerType = layer.layerType;
                    if (!(value in used)) {
                        used[value] = 1;
                        if(type == layerType){
                            const label = document.createElement("label");
                            const checkbox = document.createElement("input");
                            checkbox.type = "checkbox";
                            checkbox.value = value;
                            checkbox.addEventListener("change", applyFilters);
                            label.appendChild(checkbox);
                            label.appendChild(document.createTextNode(' '+layerName));
                            const image = document.createElement("img");
                            image.src = './layers/cb-layer-'+value.padStart(4, '0') +'.png';
                            image.classList.add('layer');
                            label.appendChild(image);
                            filterContainer.appendChild(label);
                        }
                    }
                })
            });
        };

        const applyFilters = () => {
            pageSize = 100;
            loadedCount = 0;
            const talentFilters = document.querySelectorAll("#talent-filters input:checked");
            const layerFilters = document.querySelectorAll("#layer-filters input:checked");
            const speciesFilters = document.querySelectorAll("#species-filters input:checked");
            const genderFilters = document.querySelectorAll("#gender-filters input:checked");

            const talents = Array.from(talentFilters).map((filter) => filter.value);
            const layers = Array.from(layerFilters).map((filter) => filter.value);
            const species = Array.from(speciesFilters).map((filter) => filter.value);
            const genders = Array.from(genderFilters).map((filter) => filter.value);

            filteredData = data.filter((item) => {
                return (
                    (!talents.length || talents.includes(item.talent)) &&
                    (!layers.length || layers.some(r=> item.layers.includes(r))) &&
                    (!species.length || species.includes(item.species)) &&
                    (!genders.length || genders.includes(item.gender))
                );
            });

            const gallery = document.getElementById("gallery");
            gallery.innerHTML = "";
            displayGallery(filteredData);
        };

        const displayGallery = (images) => {
            const gallery = document.getElementById("gallery");
            
            images.splice(loadedCount,Math.min(images.length, pageSize)).forEach((image) => {
                const img = document.createElement("img");
                img.src = image.imageAws;
                img.alt = image.name;
                img.title = image.name;
                gallery.appendChild(img);
            });
            loadedCount = Math.min(images.length, pageSize);
            document.getElementById('load_more').style.display = images.length > pageSize ? 'block' : 'none'; 
        };

        createFilterCheckboxes("talent", "talent-filters");
        var result = [];
        var lookup = {};
        for (var item, i = 0; item = layers[i++];) {
            var name = item.layerType;

            if (!(name in lookup)) {
                lookup[name] = 1;
                result.push(name);
            }
        }
        result.forEach((layerType)=>{
            let layers = document.getElementById("layer-filters");
            layers.innerHTML += `<span class="clickable" onclick="toggle('layer-filters-${layerType}')">&#8964; ${layerType}:</span>
                                 <div class="layer-filters" id="layer-filters-${layerType}" style="display: none;"></div><br>`
            setTimeout(()=>{createFilterCheckboxes2("layers", "layer-filters-"+layerType, layerType);},0);
        })
        
        createFilterCheckboxes("species", "species-filters");
        createFilterCheckboxes("gender", "gender-filters");
        displayGallery(data);
</script>

</body>
</html>
    